# 運用メモ（流れ）

目的: 初見でも「次に何をやるか」が分かるように、よく使う流れだけを短くまとめる。

## 用語（この資料での呼び方）

- **集計表（xlsm）**: 得点入力や集計に使うマクロ付きExcel。
- **対戦一覧_短縮**: 集計表側で生成される“最終の対戦リスト”。配布物のマスターにする。
- **チームリスト v2（xlsx）**: `チーム一覧` シートを持つ入力Excel（列名揺れ対応済み）。
- **配布物セット（最終成果物）**:
  - スケジュールExcel（対戦表/個人/短縮一覧入り）
  - 配布HTML（対戦表+短縮+個人）
  - 壁貼りHTML（コート別）
  - 得点記入表HTML（スコアシート）

---

## まず結論（迷いにくいルール）

- **現場で修正が入る可能性があるなら、マスターは集計表（xlsm）1つに寄せる**
- 配布物は **必ずマスター（集計表の `対戦一覧_短縮`）から再生成** する

---

## 全体の流れ（分岐）

1. 入口を決める
   - A. 「チームリストから自動で作る」 → `release-from-team-list`
   - B. 「集計表（短縮一覧）が正」 → `release-from-summary`

2. 現場修正が入ったら
   - 集計表を更新 → マクロで `対戦一覧_短縮` 更新 → `release-from-summary`

---

## A) チームリストから自動生成（修正が少ない/事前作成向け）

**やること: 1コマンドで配布物セットを作る**

```powershell
bsched release-from-team-list --input-file "チームリスト.xlsx" --no-relax-max-consecutive --max-consecutive 2 --diversity-attempts 20
```

- `--no-relax-max-consecutive` を付けると、**3連戦が出る案は採用しない**（時間はかかるが事故りにくい）
- 出力例: `graph_schedule_YYYYMMDD_HHMMSS.xlsx/.html/_wall.html/_score_sheets.html`

### A-1) もし現場で入れ替え（手修正）が発生したら

- **手修正した結果は、集計表（xlsm）へ反映**してマクロ更新し、以後は「B)」で回すのが安全。

---

## B) 集計表（xlsm）がマスター（現場修正を回収して最終出力）

**前提: 集計表（xlsm）の `対戦一覧_短縮` が最新**

- 必須: Excelでマクロを実行して `対戦一覧_短縮` を更新し、保存してから使う（古いままだと出力も古い）

### B-0) 最終配布物セットを一発で出す

```powershell
bsched release-from-summary --input-file "集計表_最新版.xlsm"
```

- 壁貼り: 2コート/枚（標準）・背景OFF（標準）
- スコアシート: 8枚/ページ（標準）

### B-1) 修正の入れ方（どこを触るか）

**パターン1: スケジュールExcelを現場で触った（入れ替え）**

1) 手修正した `schedule.xlsx` を集計表の入力グリッドへ流し込み

```powershell
python -m badminton_program.scheduler fill-summary-grid-from-xlsx --schedule-file "schedule.xlsx" --summary-file "集計表_元.xlsm"
```

2) 生成された `*_filled_from_xlsx.xlsm` をExcelで開く
3) マクロで `対戦一覧_短縮` を更新
4) `release-from-summary` で最終配布物を作る

**パターン2: 集計表（xlsm）側で直接直した（当日運用）**

1) 集計表を開いて必要箇所を修正
2) マクロで `対戦一覧_短縮` を更新
3) `release-from-summary` で最終配布物を作る

---

## 印刷の注意（壁貼り/スコアシート共通）

- HTMLは環境（ブラウザ/プリンタ）で余白や縮尺が変わるため、**印刷ダイアログで倍率（Scale）を確認/固定**する
- 例: Edge/Chrome で `Ctrl+P` → 「倍率」= `100%`（または現場で最適な値）

---

## よくある詰まりポイント

- `Permission denied` / `Invalid value: Excelファイルを開いたまま…`
  - **Excelで対象ファイルを開いたまま**のことが多いです。閉じてから再実行してください。

